(this.webpackJsonp=this.webpackJsonp||[]).push([["impersonation"],{"/3U3":function(e,t,i){"use strict";i.d(t,"a",(function(){return l})),i.d(t,"b",(function(){return f}));var n=i("lwsE"),r=i.n(n),o=i("W8MJ"),s=i.n(o),a=Shopware,c=a.Application,u=a.WorkerNotification,l=3e4,f=5e3,p=function(){function e(t){r()(this,e),this._context=t,this._isRunning=!1,this._isRequestRunning=!1,this._interval=l,this._isIntervalWatcherSetup=!1,this._timeoutId=null,this._applicationRoot=null,this._middlewareHelper=null}return s()(e,[{key:"start",value:function(){this._isRunning=!0,this._middlewareHelper=u.initialize(),this._timeoutId=setTimeout(this._checkQueue.bind(this),this._interval),this.setupIntervalWatcher()}},{key:"terminate",value:function(){this._isRunning=!1,null!==this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=null)}},{key:"setupIntervalWatcher",value:function(){this._isIntervalWatcherSetup||(Shopware.State.watch((function(e){return e.notification.workerProcessPollInterval}),this._onPollIntervalChanged.bind(this)),this._isIntervalWatcherSetup=!0)}},{key:"getMessageQueueStatsRepository",value:function(){return Shopware.Service().get("repositoryFactory").create("message_queue_stats")}},{key:"_checkQueue",value:function(){var e=this;this._isRequestRunning=!0,this.getMessageQueueStatsRepository().search(new Shopware.Data.Criteria(1,25),this._context).then((function(t){e._isRequestRunning=!1,e._timeoutId=null,e.runNotificationMiddleware(t),e._isRunning&&(e._interval=e._getApplicationRootReference().$store.state.notification.workerProcessPollInterval,e._timeoutId=setTimeout(e._checkQueue.bind(e),e._interval))}))}},{key:"_onPollIntervalChanged",value:function(e){this._interval=e,this._isRequestRunning||(null!==this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=null),e!==f?this._timeoutId=setTimeout(this._checkQueue.bind(this),this._interval):this._checkQueue())}},{key:"runNotificationMiddleware",value:function(e){var t=this._getApplicationRootReference(),i={$root:t,notification:{create:function(e){return t.$store.dispatch("notification/createNotification",e)},update:function(e){return t.$store.dispatch("notification/updateNotification",e)}},queue:e};this._middlewareHelper.go(i)}},{key:"_getApplicationRootReference",value:function(){return this._applicationRoot||(this._applicationRoot=c.getApplicationRoot()),this._applicationRoot}}]),e}();t.c=p},JXUN:function(e,t){e.exports='{% block sw_page_top_bar_actions %}\n    <div class="sw-page__top-bar-actions" :style="topBarActionStyles">\n        {% block sw_page_leave_impersonation_button %}\n            <sw-button v-if="isImpersonating"\n                       class="impersonation-btn"\n                       variant="danger"\n                       size="x-small"\n                       :disabled="isLoading"\n                       :isLoading="isLoading"\n                       @click="leaveImpersonation">{{ $tc(\'impersonation.actions.leaveImpersonation\') }}</sw-button>\n        {% endblock %}\n\n        {% block sw_page_notification_center %}\n            <sw-notification-center></sw-notification-center>\n        {% endblock %}\n    </div>\n{% endblock %}\n'},Vx7a:function(e,t){e.exports='{% block sw_settings_user_list_actions_edit %}\n    {% parent() %}\n\n    {% block sw_settings_user_list_actions_impersonate %}\n        <sw-context-menu-item\n            v-if="canImpersonate && !isImpersonating"\n            :disabled="currentUser.id === item.id"\n            class="sw-settings-user-list__user-view-action"\n            @click="impersonate(item.id)">\n            {{ $tc(\'impersonation.actions.impersonate\') }}\n        </sw-context-menu-item>\n    {% endblock %}\n{% endblock %}\n'},f1yM:function(e,t,i){"use strict";i.d(t,"b",(function(){return m}));var n=i("lSNA"),r=i.n(n),o=i("/3U3");function s(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function a(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?s(Object(i),!0).forEach((function(t){r()(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):s(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var c=Shopware,u=c.Application,l=c.State,f=Shopware.Utils.debug,p=Shopware.Utils;function m(){u.getApplicationRoot().$store?u.getApplicationRoot().$store.commit("notification/setNotificationsForCurrentUser"):l.get("notification").notifications=d()}function v(){var e=l.get("session").currentUser;if(!e)return null;var t=e.id;return t?"notifications#".concat(t):null}function d(){var e=v();if(!e)return{};var t=localStorage.getItem(e);if(!t)return localStorage.setItem(e,JSON.stringify({})),{};for(var i=JSON.parse(t),n=Object.keys(i).reverse(),r={},o=Math.min(50,n.length)-1;o>=0;o-=1){var s=n[o];r[s]=a(a({},i[s]),{},{timestamp:new Date(i[s].timestamp)})}return n.length>50&&g(r),r}function g(e){var t=v();if(t){var i={};Object.keys(e).forEach((function(t){!1===e[t].isLoading&&(i[t]=a(a({},e[t]),{},{timestamp:e[t].timestamp.toJSON()}))})),localStorage.setItem(t,JSON.stringify(i))}}t.a={namespaced:!0,state:{notifications:{},growlNotifications:{},threshold:5,workerProcessPollInterval:o.a,notificationDefaults:{visited:!1,metadata:{},isLoading:!1},growlNotificationDefaults:{system:!1,variant:"info",autoClose:!0,duration:5e3}},getters:{getNotifications:function(e){return Object.values(e.notifications).reverse()},getGrowlNotifications:function(e){return Object.values(e.growlNotifications)}},mutations:{setThreshold:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;e.threshold=t,e.growlNotifications.length>e.threshold&&e.growlNotifications.splice(t,e.growlNotifications.length-e.threshold)},setWorkerProcessPollInterval:function(e,t){e.workerProcessPollInterval=t},setNotificationsForCurrentUser:function(e){e.notifications=d()},clearNotificationsForCurrentUser:function(e){e.notifications={};var t=v();t&&localStorage.removeItem(t)},clearGrowlNotificationsForCurrentUser:function(e){e.growlNotifications={}},setNotifications:function(e,t){Object.keys(t).forEach((function(i){u.view.setReactive(e.notifications,t[i].uuid,t[i])}))},upsertNotification:function(e,t){var i=e.notifications[t.uuid];void 0===i?(u.view.setReactive(e.notifications,t.uuid,t),g(e.notifications)):Object.assign(i,t)},removeNotification:function(e,t){u.view.deleteReactive(e.notifications,t.uuid),g(e.notifications)},setAllNotificationsVisited:function(e){Object.keys(e.notifications).forEach((function(t){e.notifications[t].visited=!0})),g(e.notifications)},upsertGrowlNotification:function(e,t){var i=e.growlNotifications[t.uuid];if(void 0===i){u.view.setReactive(e.growlNotifications,t.uuid,t);var n=Object.keys(e.growlNotifications);n.length>e.threshold&&u.view.deleteReactive(e.growlNotifications,n[0])}else Object.assign(i,t)},removeGrowlNotification:function(e,t){u.view.deleteReactive(e.growlNotifications,t.uuid)}},actions:{createNotification:function(e,t){var i=e.state,n=e.commit,r=e.dispatch;if(!t.message)return f.warn("NotificationStore","A message must be specified",t),null;void 0!==t.growl&&!0!==t.growl||r("createGrowlNotification",t),delete t.growl;var o=Object.assign({},i.notificationDefaults,t,{uuid:p.createId(),timestamp:new Date});return"success"===o.variant?null:(n("upsertNotification",o),o.uuid)},createGrowlNotification:function(e,t){var i=e.state,n=e.commit,r=Object.assign({},i.growlNotificationDefaults,t,{uuid:p.createId(),timestamp:new Date});delete r.growl,n("upsertGrowlNotification",r),r.autoClose&&setTimeout((function(){n("removeGrowlNotification",r)}),r.duration)},updateNotification:function(e,t){var i=e.state,n=e.commit,r=e.dispatch;if(!t.uuid)return f.warn("NotificationStore","Update to an notification must contain the uuid",t),null;var o=function(e,t){var i=t.notifications[e];return void 0===i&&(i=Object.assign({},t.notificationDefaults,{uuid:e,timestamp:new Date})),i}(t.uuid,i),s=function(e,t){return Object.assign({},e,{visited:t.metadata?JSON.stringify(e.metadata)===JSON.stringify(t.metadata):e.visited},t)}(o,t);return n("upsertNotification",s),void 0!==t.growl&&!0===t.growl&&r("createGrowlNotification",s),o.uuid},setAllNotificationsVisited:function(e){(0,e.commit)("setAllNotificationsVisited")}}}},gKsz:function(e,t,i){},mUXG:function(e,t,i){"use strict";i.r(t);var n="impersonated-user-id",r=i("f1yM");function o(e,t){if(null==e)return{};var i,n,r=function(e,t){if(null==e)return{};var i,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)i=o[n],t.indexOf(i)>=0||(r[i]=e[i]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)i=o[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(r[i]=e[i])}return r}function s(e,t,i,n,r,o,s){try{var a=e[o](s),c=a.value}catch(e){return void i(e)}a.done?t(c):Promise.resolve(c).then(n,r)}function a(e){return function(){var t=this,i=arguments;return new Promise((function(n,r){var o=e.apply(t,i);function a(e){s(o,n,r,a,c,"next",e)}function c(e){s(o,n,r,a,c,"throw",e)}a(void 0)}))}}function c(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var u=Shopware.State,l=function(){function e(t,i,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.name="impersonationService";var r=i.userService,o=i.localeHelper,s=i.loginService;this.userService=r,this.localeHelper=o,this.loginService=s,this.impersonatingUser=t,this.httpClient=n,this._initializeService()}var t,i,s,l,f,p;return t=e,(i=[{key:"impersonate",value:(p=a(regeneratorRuntime.mark((function e(t){var i,r,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return localStorage.setItem(n,t),e.next=3,this.userService.getUser({},(u=t,(c=n)in(a={})?Object.defineProperty(a,c,{value:u,enumerable:!0,configurable:!0,writable:!0}):a[c]=u,a));case 3:return i=e.sent,(r=i.data).password,s=o(r,["password"]),e.next=7,this._initializeUser(s);case 7:case"end":return e.stop()}var a,c,u}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"leaveImpersonation",value:(f=a(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return localStorage.removeItem(n),e.next=3,this._initializeUser(this.impersonatingUser);case 3:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"isImpersonating",value:function(){return!!localStorage.getItem(n)}},{key:"_initializeUser",value:(l=a(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u.commit("setCurrentUser",t),e.next=3,this.localeHelper.setLocaleWithId(t.localeId);case 3:u.commit("context/setApiLanguageId",u.get("session").languageId),Object(r.b)();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"_initializeService",value:function(){var e=this;this.httpClient.interceptors.request.use((function(t){return e.isImpersonating()&&(t.headers=t.headers||{},t.headers["impersonated-user-id"]=localStorage.getItem(n)),t})),this._registerLogInListener(),this.isImpersonating()&&this.impersonate(localStorage.getItem(n))}},{key:"_registerLogInListener",value:function(){var e=this;this.loginService.addOnLoginListener(a(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.isImpersonating()){t.next=3;break}return t.next=3,e.leaveImpersonation();case 3:case"end":return t.stop()}}),t)}))))}}])&&c(t.prototype,i),s&&c(t,s),e}(),f=Shopware,p=f.State,m=f.Application,v=m.getContainer("init"),d=p.get("session").currentUser,g=v.httpClient;m.addServiceProvider("impersonationService",(function(e){return new l(d,e,g)}));var h=i("Vx7a"),w=i.n(h);function b(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function _(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?b(Object(i),!0).forEach((function(t){y(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):b(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function y(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function S(e,t,i,n,r,o,s){try{var a=e[o](s),c=a.value}catch(e){return void i(e)}a.done?t(c):Promise.resolve(c).then(n,r)}var O=Shopware,I=O.Component,k=O.Service,N=O.State,R={computed:{impersonationService:function(){return k("impersonationService")},currentUser:function(){return N.get("session").currentUser},canImpersonate:function(){return!!this.currentUser.admin},isImpersonating:function(){return this.impersonationService.isImpersonating()}},methods:{impersonate:function(e){var t,i=this;return(t=regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i.canImpersonate){t.next=2;break}return t.abrupt("return");case 2:return i.isLoading=!0,t.next=5,i.impersonationService.impersonate(e);case 5:i.isLoading=!1,i.$router.push({name:"sw.dashboard.index"});case 7:case"end":return t.stop()}}),t)})),function(){var e=this,i=arguments;return new Promise((function(n,r){var o=t.apply(e,i);function s(e){S(o,n,r,s,a,"next",e)}function a(e){S(o,n,r,s,a,"throw",e)}s(void 0)}))})()}}};I.getComponentRegistry().has("sw-settings-user-list")?I.override("sw-settings-user-list",_({template:w.a,deprecated:{version:"6.4.0",comment:"Use sw-users-permissions-user-listing instead"}},R)):I.override("sw-users-permissions-user-listing",_({template:w.a},R));var j=i("JXUN"),P=i.n(j);i("vUXJ");function x(e,t,i,n,r,o,s){try{var a=e[o](s),c=a.value}catch(e){return void i(e)}a.done?t(c):Promise.resolve(c).then(n,r)}var U=Shopware,C=U.Component,D=U.State,L=U.Service;C.override("sw-page",{template:P.a,data:function(){return{isLoading:!1}},computed:{currentUser:function(){return D.get("session").currentUser},pageClasses:function(){var e=this.$super("pageClasses");return e["has--leave-impersonation-button"]=this.isImpersonating,e},impersonationService:function(){return L("impersonationService")},isImpersonating:function(){return this.impersonationService.isImpersonating()}},methods:{leaveImpersonation:function(){var e,t=this;return(e=regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.isLoading=!0,e.next=3,t.impersonationService.leaveImpersonation();case 3:t.isLoading=!1,"sw.users.permissions.index"===t.$route.name?t.$router.go():t.$router.push({name:"sw.users.permissions.index"});case 5:case"end":return e.stop()}}),e)})),function(){var t=this,i=arguments;return new Promise((function(n,r){var o=e.apply(t,i);function s(e){x(o,n,r,s,a,"next",e)}function a(e){x(o,n,r,s,a,"throw",e)}s(void 0)}))})()}}}),Shopware.Module.register("impersonation",{type:"plugin",name:"Impersonation",version:"1.0.0",targetVersion:"1.0.0"})},vUXJ:function(e,t,i){var n=i("gKsz");"string"==typeof n&&(n=[[e.i,n,""]]),n.locals&&(e.exports=n.locals);(0,i("SZ7m").default)("1dc1b65b",n,!0,{})}},[["mUXG","runtime","vendors-node"]]]);